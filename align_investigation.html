
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Investigating alignment &#8212; Maggot Connectome</title>
    
  <link rel="stylesheet" href="_static/css/index.f658d18f9b420779cfdf24aa0a7e2d77.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.e7340bb3dbd8dde6db86f25597f54a1b.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.d3f166471bb80abb5163.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.7d483ff0a819d6edff12ce0b1ead3928.js"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <link rel="shortcut icon" href="_static/nd_logo_small.png"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Off-diagonal and off-script" href="off_diagonal.html" />
    <link rel="prev" title="Testing bilateral symmetry" href="bilateral_symmetry.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  <img src="_static/nd_logo.png" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">Maggot Connectome</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="landing.html">
   Welcome
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Preliminaries
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="outline.html">
   Outline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="introduction.html">
   Introduction
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Look at it
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="simple_statistics.html">
   Simple summary statistics
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  A priori modeling
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="a_priori_sbm.html">
   A priori SBMs
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Bilateral symmetry
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="look_at_paired_embeddings.html">
   Look at the paired embeddings
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="bilateral_symmetry.html">
   Testing bilateral symmetry
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Investigating alignment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="off_diagonal.html">
   Off-diagonal and off-script
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Matching
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="matching_illustration.html">
   Matching the two sides of the brain
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="match_with_contra.html">
   Matching when including the contralateral connections
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Feedforwardness
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="feedforwardness_sims.html">
   One-sample feedforwardness testing: simulation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="feedforwardness_data.html">
   One-sample feedforwardness testing: data
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  Appendix
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="modularity.html">
   Modularity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="flow_rank_hypothesis.html">
   Flow ranking and hypothesis testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="flow_rank.html">
   Flow
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="visualizing_a_prior_sbm.html">
   Visualizing a priori SBMs
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/align_investigation.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/neurodata/maggot_connectome"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/neurodata/maggot_connectome/issues/new?title=Issue%20on%20page%20%2Falign_investigation.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>


            <!-- Full screen (wrap in <a> to have style consistency -->
            <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                    data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                    title="Fullscreen mode"><i
                        class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i>
            Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preliminaries">
   Preliminaries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#load-and-process-data">
   Load and process data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluate-the-pairs-using-graph-matching">
   Evaluate the pairs using graph matching
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#investigate-alignment-methods">
   Investigate alignment methods
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-the-initial-embedding-using-ase">
     Run the initial embedding using ASE
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-screeplots">
     Plot screeplots
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-latent-positions-without-alignment">
     Plot the latent positions without alignment
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#align-the-3-dimensional-out-embeddings-using-known-or-predicted-pairs">
     Align the 3-dimensional out embeddings using known or predicted pairs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-results-of-these-two-kinds-of-alignment-using-orthogonal-procrustes">
     Plot the results of these two kinds of alignment using orthogonal Procrustes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-results-of-these-two-kinds-of-alignment-using-seedless-procrustes">
     Plot the results of these two kinds of alignment using seedless Procrustes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-results-of-aligning-with-seedless-procrustes-using-all-dimension-flip-initializations">
     Plot the results of aligning with seedless Procrustes using all dimension flip initializations
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#embed-using-omni-instead-of-ase-align">
     Embed using Omni instead of ASE + align
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-left-omni-embedding-by-rough-cell-type">
     Plot the left Omni embedding by rough cell type
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#what-happens-when-we-remove-the-kenyon-cells">
   What happens when we remove the Kenyon cells?
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#align-the-3-dimensional-out-embeddings-using-known-pairs">
     Align the 3-dimensional out embeddings using known pairs
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-results-of-alignment-using-orthogonal-procrustes">
     Plot the results of alignment using orthogonal Procrustes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-results-of-alignment-using-seedless-procrustes">
     Plot the results of alignment using seedless Procrustes
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#plot-the-embeddings-using-omni-with-the-known-pair-correspondence">
     Plot the embeddings using Omni with the known pair correspondence
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#end">
   End
  </a>
 </li>
</ul>

        </nav>
        
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="investigating-alignment">
<h1>Investigating alignment<a class="headerlink" href="#investigating-alignment" title="Permalink to this headline">¶</a></h1>
<p>In <a class="reference internal" href="bilateral_symmetry.html"><span class="doc">Testing bilateral symmetry</span></a>, we saw how odd some of the embedding alignments can
be, and how large of an effect they have on downstream analysis.</p>
<p>Here, we investigate some of these embedding alignments in more detail. In summary, we
will:</p>
<ul class="simple">
<li><p>Look at the known pairs and how they compare to pairs that we’d predict via graph
matching. We will also try using the graph-matching-predicted pairs as the vertex
correspondence for Procrustes matching</p></li>
<li><p>Try using Omni instead of ASE to embed</p></li>
<li><p>Try removing the paired Kenyon cells from this analysis to see whether they have
much effect on the alignments above.</p></li>
</ul>
<div class="section" id="preliminaries">
<h2>Preliminaries<a class="headerlink" href="#preliminaries" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pkg.utils</span> <span class="kn">import</span> <span class="n">set_warnings</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">graspologic.align</span> <span class="kn">import</span> <span class="n">OrthogonalProcrustes</span><span class="p">,</span> <span class="n">SeedlessProcrustes</span>
<span class="kn">from</span> <span class="nn">graspologic.embed</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AdjacencySpectralEmbed</span><span class="p">,</span>
    <span class="n">OmnibusEmbed</span><span class="p">,</span>
    <span class="n">select_dimension</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">graspologic.match</span> <span class="kn">import</span> <span class="n">GraphMatch</span>
<span class="kn">from</span> <span class="nn">graspologic.plot</span> <span class="kn">import</span> <span class="n">pairplot</span>
<span class="kn">from</span> <span class="nn">graspologic.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">augment_diagonal</span><span class="p">,</span>
    <span class="n">binarize</span><span class="p">,</span>
    <span class="n">multigraph_lcc_intersection</span><span class="p">,</span>
    <span class="n">pass_to_ranks</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">pkg.data</span> <span class="kn">import</span> <span class="n">load_maggot_graph</span><span class="p">,</span> <span class="n">load_palette</span>
<span class="kn">from</span> <span class="nn">pkg.io</span> <span class="kn">import</span> <span class="n">savefig</span>
<span class="kn">from</span> <span class="nn">pkg.plot</span> <span class="kn">import</span> <span class="n">set_theme</span>


<span class="kn">from</span> <span class="nn">src.visualization</span> <span class="kn">import</span> <span class="n">adjplot</span>  <span class="c1"># TODO fix graspologic version and replace here</span>

<span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">stashfig</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">foldername</span> <span class="o">=</span> <span class="s2">&quot;align_investigation&quot;</span>
    <span class="n">savefig</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">foldername</span><span class="o">=</span><span class="n">foldername</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;Set1&quot;</span><span class="p">)</span>
<span class="n">palette</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;Left&quot;</span><span class="p">,</span> <span class="s2">&quot;Right&quot;</span><span class="p">],</span> <span class="n">colors</span><span class="p">))</span>
<span class="n">set_theme</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><script type="text/javascript">
window.PlotlyConfig = {MathJaxConfig: 'local'};
if (window.MathJax) {MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}
if (typeof require !== 'undefined') {
require.undef("plotly");
requirejs.config({
    paths: {
        'plotly': ['https://cdn.plot.ly/plotly-latest.min']
    }
});
require(['plotly'], function(Plotly) {
    window._Plotly = Plotly;
});
}
</script>
</div></div>
</div>
</div>
<div class="section" id="load-and-process-data">
<h2>Load and process data<a class="headerlink" href="#load-and-process-data" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mg</span> <span class="o">=</span> <span class="n">load_maggot_graph</span><span class="p">()</span>
<span class="n">mg</span> <span class="o">=</span> <span class="n">mg</span><span class="p">[</span><span class="n">mg</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;paper_clustered_neurons&quot;</span><span class="p">]]</span>

<span class="n">ll_mg</span><span class="p">,</span> <span class="n">rr_mg</span><span class="p">,</span> <span class="n">lr_mg</span><span class="p">,</span> <span class="n">rl_mg</span> <span class="o">=</span> <span class="n">mg</span><span class="o">.</span><span class="n">bisect</span><span class="p">(</span><span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ll_adj</span> <span class="o">=</span> <span class="n">ll_mg</span><span class="o">.</span><span class="n">sum</span><span class="o">.</span><span class="n">adj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">rr_adj</span> <span class="o">=</span> <span class="n">rr_mg</span><span class="o">.</span><span class="n">sum</span><span class="o">.</span><span class="n">adj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">nodes</span> <span class="o">=</span> <span class="n">ll_mg</span><span class="o">.</span><span class="n">nodes</span>
<span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;_inds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>
<span class="n">sorted_nodes</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;simple_group&quot;</span><span class="p">])</span>
<span class="n">sort_inds</span> <span class="o">=</span> <span class="n">sorted_nodes</span><span class="p">[</span><span class="s2">&quot;_inds&quot;</span><span class="p">]</span>

<span class="n">ll_adj</span> <span class="o">=</span> <span class="n">ll_adj</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">sort_inds</span><span class="p">,</span> <span class="n">sort_inds</span><span class="p">)]</span>
<span class="n">rr_adj</span> <span class="o">=</span> <span class="n">rr_adj</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">sort_inds</span><span class="p">,</span> <span class="n">sort_inds</span><span class="p">)]</span>

<span class="n">adjs</span><span class="p">,</span> <span class="n">lcc_inds</span> <span class="o">=</span> <span class="n">multigraph_lcc_intersection</span><span class="p">([</span><span class="n">ll_adj</span><span class="p">,</span> <span class="n">rr_adj</span><span class="p">],</span> <span class="n">return_inds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ll_adj</span> <span class="o">=</span> <span class="n">adjs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rr_adj</span> <span class="o">=</span> <span class="n">adjs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lcc_inds</span><span class="p">)</span><span class="si">}</span><span class="s2"> in intersection of largest connected components.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_adjs</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">adjplot</span><span class="p">(</span>
        <span class="n">left</span><span class="p">,</span>
        <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;scattermap&quot;</span><span class="p">,</span>
        <span class="n">sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Left $\to$ left&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s2">&quot;Left&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">adjplot</span><span class="p">(</span>
        <span class="n">right</span><span class="p">,</span>
        <span class="n">plot_type</span><span class="o">=</span><span class="s2">&quot;scattermap&quot;</span><span class="p">,</span>
        <span class="n">sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;Right $\to$ right&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s2">&quot;Right&quot;</span><span class="p">],</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.51</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axs</span>


<span class="n">plot_adjs</span><span class="p">(</span><span class="n">ll_adj</span><span class="p">,</span> <span class="n">rr_adj</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Known alignment&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1144 in intersection of largest connected components.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;Figure size 1080x504 with 2 Axes&gt;,
 array([&lt;AxesSubplot:title={&#39;center&#39;:&#39;Left $\\to$ left&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;Right $\\to$ right&#39;}&gt;], dtype=object))
</pre></div>
</div>
<img alt="_images/align_investigation_4_2.png" src="_images/align_investigation_4_2.png" />
</div>
</div>
</div>
<div class="section" id="evaluate-the-pairs-using-graph-matching">
<h2>Evaluate the pairs using graph matching<a class="headerlink" href="#evaluate-the-pairs-using-graph-matching" title="Permalink to this headline">¶</a></h2>
<p>Here, we run graph matching either starting from the known pairs (idendtity matrix as
the initial position for FAQ) or from the barycenter. The goal is to evaluate how good
the known pairs are relative to what we’d predict from graph matching.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">888888</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ll_adj</span><span class="p">)</span>

<span class="n">currtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">gm</span> <span class="o">=</span> <span class="n">GraphMatch</span><span class="p">(</span><span class="n">n_init</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s2">&quot;barycenter&quot;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">shuffle_input</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
<span class="n">gm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ll_adj</span><span class="p">,</span> <span class="n">rr_adj</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">currtime</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds elapsed to run graph matching.&quot;</span><span class="p">)</span>
<span class="n">perm_inds</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">perm_inds_</span>
<span class="n">match_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">perm_inds</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Match ratio when initializing from barycenter:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">match_ratio</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GMP objective function after initializing from barycenter:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gm</span><span class="o">.</span><span class="n">score_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="n">currtime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">gm</span> <span class="o">=</span> <span class="n">GraphMatch</span><span class="p">(</span><span class="n">n_init</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">shuffle_input</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
<span class="n">gm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">ll_adj</span><span class="p">,</span> <span class="n">rr_adj</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">currtime</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2"> seconds elapsed to run graph matching.&quot;</span><span class="p">)</span>
<span class="n">perm_inds</span> <span class="o">=</span> <span class="n">gm</span><span class="o">.</span><span class="n">perm_inds_</span>
<span class="n">match_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="n">perm_inds</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Match ratio when initializing from known pairs:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">match_ratio</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GMP objective function after initializing from known pairs:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">gm</span><span class="o">.</span><span class="n">score_</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GMP objective function from known pairs:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">((</span><span class="n">ll_adj</span> <span class="o">*</span> <span class="n">rr_adj</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>74.674 seconds elapsed to run graph matching.
Match ratio when initializing from barycenter:
0.7937062937062938
GMP objective function after initializing from barycenter:
795173.0

32.199 seconds elapsed to run graph matching.
Match ratio when initializing from known pairs:
0.8802447552447552
GMP objective function after initializing from known pairs:
851471.0

GMP objective function from known pairs:
847292.0
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="investigate-alignment-methods">
<h2>Investigate alignment methods<a class="headerlink" href="#investigate-alignment-methods" title="Permalink to this headline">¶</a></h2>
<div class="section" id="run-the-initial-embedding-using-ase">
<h3>Run the initial embedding using ASE<a class="headerlink" href="#run-the-initial-embedding-using-ase" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="n">adj</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">ptr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ptr</span><span class="p">:</span>
        <span class="n">adj</span> <span class="o">=</span> <span class="n">pass_to_ranks</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span>
    <span class="n">elbow_inds</span><span class="p">,</span> <span class="n">elbow_vals</span> <span class="o">=</span> <span class="n">select_dimension</span><span class="p">(</span><span class="n">augment_diagonal</span><span class="p">(</span><span class="n">adj</span><span class="p">),</span> <span class="n">n_elbows</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">elbow_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">elbow_inds</span><span class="p">)</span>
    <span class="n">ase</span> <span class="o">=</span> <span class="n">AdjacencySpectralEmbed</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">n_components</span><span class="p">)</span>
    <span class="n">out_latent</span><span class="p">,</span> <span class="n">in_latent</span> <span class="o">=</span> <span class="n">ase</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">adj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_latent</span><span class="p">,</span> <span class="n">in_latent</span><span class="p">,</span> <span class="n">ase</span><span class="o">.</span><span class="n">singular_values_</span><span class="p">,</span> <span class="n">elbow_inds</span>


<span class="k">def</span> <span class="nf">preprocess_for_embed</span><span class="p">(</span><span class="n">ll_adj</span><span class="p">,</span> <span class="n">rr_adj</span><span class="p">,</span> <span class="n">preprocess</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;binarize&quot;</span> <span class="ow">in</span> <span class="n">preprocess</span><span class="p">:</span>
        <span class="n">ll_adj_to_embed</span> <span class="o">=</span> <span class="n">binarize</span><span class="p">(</span><span class="n">ll_adj</span><span class="p">)</span>
        <span class="n">rr_adj_to_embed</span> <span class="o">=</span> <span class="n">binarize</span><span class="p">(</span><span class="n">rr_adj</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;rescale&quot;</span> <span class="ow">in</span> <span class="n">preprocess</span><span class="p">:</span>
        <span class="n">ll_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ll_adj_to_embed</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="s2">&quot;fro&quot;</span><span class="p">)</span>
        <span class="n">rr_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rr_adj_to_embed</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="s2">&quot;fro&quot;</span><span class="p">)</span>
        <span class="n">mean_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">ll_norm</span> <span class="o">+</span> <span class="n">rr_norm</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">ll_adj_to_embed</span> <span class="o">*=</span> <span class="n">mean_norm</span> <span class="o">/</span> <span class="n">ll_norm</span>
        <span class="n">rr_adj_to_embed</span> <span class="o">*=</span> <span class="n">mean_norm</span> <span class="o">/</span> <span class="n">rr_norm</span>
    <span class="k">return</span> <span class="n">ll_adj_to_embed</span><span class="p">,</span> <span class="n">rr_adj_to_embed</span>


<span class="n">n_components</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">max_n_components</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">preprocess</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;binarize&quot;</span><span class="p">,</span> <span class="s2">&quot;rescale&quot;</span><span class="p">]</span>

<span class="n">ll_adj_to_embed</span><span class="p">,</span> <span class="n">rr_adj_to_embed</span> <span class="o">=</span> <span class="n">preprocess_for_embed</span><span class="p">(</span><span class="n">ll_adj</span><span class="p">,</span> <span class="n">rr_adj</span><span class="p">,</span> <span class="n">preprocess</span><span class="p">)</span>

<span class="c1"># for someone else to run this experiment too</span>
<span class="c1"># np.savetxt(</span>
<span class="c1">#     &quot;maggot_connectome/results/outputs/align_investigation/left_adj.csv&quot;,</span>
<span class="c1">#     ll_adj_to_embed,</span>
<span class="c1">#     delimiter=&quot;,&quot;,</span>
<span class="c1"># )</span>
<span class="c1"># np.savetxt(</span>
<span class="c1">#     &quot;maggot_connectome/results/outputs/align_investigation/right_adj.csv&quot;,</span>
<span class="c1">#     rr_adj_to_embed,</span>
<span class="c1">#     delimiter=&quot;,&quot;,</span>
<span class="c1"># )</span>

<span class="n">left_out</span><span class="p">,</span> <span class="n">left_in</span><span class="p">,</span> <span class="n">left_sing_vals</span><span class="p">,</span> <span class="n">left_elbow_inds</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span>
    <span class="n">ll_adj_to_embed</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="n">max_n_components</span>
<span class="p">)</span>
<span class="n">right_out</span><span class="p">,</span> <span class="n">right_in</span><span class="p">,</span> <span class="n">right_sing_vals</span><span class="p">,</span> <span class="n">right_elbow_inds</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span>
    <span class="n">rr_adj_to_embed</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="n">max_n_components</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plot-screeplots">
<h3>Plot screeplots<a class="headerlink" href="#plot-screeplots" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">screeplot</span><span class="p">(</span><span class="n">sing_vals</span><span class="p">,</span> <span class="n">elbow_inds</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sing_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">sing_vals</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="n">elbow_inds</span><span class="p">,</span> <span class="n">sing_vals</span><span class="p">[</span><span class="n">elbow_inds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Singular value&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Index&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">screeplot</span><span class="p">(</span><span class="n">left_sing_vals</span><span class="p">,</span> <span class="n">left_elbow_inds</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s2">&quot;Left&quot;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Left&quot;</span><span class="p">)</span>
<span class="n">screeplot</span><span class="p">(</span>
    <span class="n">right_sing_vals</span><span class="p">,</span> <span class="n">right_elbow_inds</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s2">&quot;Right&quot;</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Right&quot;</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">n_components</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">stashfig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;screeplot-preprocess=</span><span class="si">{</span><span class="n">preprocess</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/align_investigation_11_0.png" src="_images/align_investigation_11_0.png" />
</div>
</div>
</div>
<div class="section" id="plot-the-latent-positions-without-alignment">
<h3>Plot the latent positions without alignment<a class="headerlink" href="#plot-the-latent-positions-without-alignment" title="Permalink to this headline">¶</a></h3>
<p>In the following figures, I usually focus on <span class="math notranslate nohighlight">\(d=3\)</span> as the embedding dimension, as this
was a small dimension where alignment was non-trivial (not just a sign flip) and in
the original experiment we rejected the null hypothesis that the left and the right
came from the same distribution (see <a class="reference internal" href="bilateral_symmetry.html"><span class="doc">Testing bilateral symmetry</span></a>).</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_latents</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">n_show</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">plot_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s2">&quot;Left&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Right&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="p">))</span>
    <span class="n">pg</span> <span class="o">=</span> <span class="n">pairplot</span><span class="p">(</span><span class="n">plot_data</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_show</span><span class="p">],</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pg</span>


<span class="n">plot_latents</span><span class="p">(</span><span class="n">left_out</span><span class="p">,</span> <span class="n">right_out</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Out latent positions (no alignment)&quot;</span><span class="p">)</span>
<span class="n">stashfig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out-latent-no-align-preprocess=</span><span class="si">{</span><span class="n">preprocess</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/align_investigation_13_0.png" src="_images/align_investigation_13_0.png" />
</div>
</div>
</div>
<div class="section" id="align-the-3-dimensional-out-embeddings-using-known-or-predicted-pairs">
<h3>Align the 3-dimensional out embeddings using known or predicted pairs<a class="headerlink" href="#align-the-3-dimensional-out-embeddings-using-known-or-predicted-pairs" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_alignments</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">scale</span><span class="p">:</span>
        <span class="n">X_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="s2">&quot;fro&quot;</span><span class="p">)</span>
        <span class="n">Y_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="s2">&quot;fro&quot;</span><span class="p">)</span>
        <span class="n">avg_norms</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_norm</span> <span class="o">+</span> <span class="n">Y_norm</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">X</span> <span class="o">*</span> <span class="p">(</span><span class="n">avg_norms</span> <span class="o">/</span> <span class="n">X_norm</span><span class="p">)</span>
        <span class="n">Y</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">*</span> <span class="p">(</span><span class="n">avg_norms</span> <span class="o">/</span> <span class="n">Y_norm</span><span class="p">)</span>
    <span class="n">op</span> <span class="o">=</span> <span class="n">OrthogonalProcrustes</span><span class="p">()</span>
    <span class="n">X_trans_op</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">SeedlessProcrustes</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s2">&quot;custom&quot;</span><span class="p">,</span> <span class="n">initial_Q</span><span class="o">=</span><span class="n">op</span><span class="o">.</span><span class="n">Q_</span><span class="p">)</span>
    <span class="n">X_trans_sp</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X_trans_op</span><span class="p">,</span> <span class="n">X_trans_sp</span>


<span class="k">def</span> <span class="nf">calc_diff_norm</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">Y</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="s2">&quot;fro&quot;</span><span class="p">)</span>


<span class="n">n_components</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># this was a small dimension where we reject</span>
<span class="n">op_known_left_out</span><span class="p">,</span> <span class="n">sp_known_left_out</span> <span class="o">=</span> <span class="n">run_alignments</span><span class="p">(</span>
    <span class="n">left_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">],</span> <span class="n">right_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">op_pred_left_out</span><span class="p">,</span> <span class="n">sp_pred_left_out</span> <span class="o">=</span> <span class="n">run_alignments</span><span class="p">(</span>
    <span class="n">left_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">],</span> <span class="n">right_out</span><span class="p">[</span><span class="n">perm_inds</span><span class="p">,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">op_diff_norm</span> <span class="o">=</span> <span class="n">calc_diff_norm</span><span class="p">(</span><span class="n">op_known_left_out</span><span class="p">,</span> <span class="n">right_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">])</span>
<span class="n">sp_diff_norm</span> <span class="o">=</span> <span class="n">calc_diff_norm</span><span class="p">(</span><span class="n">sp_known_left_out</span><span class="p">,</span> <span class="n">right_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Procrustes diff. norm using true pairs: </span><span class="si">{</span><span class="n">op_diff_norm</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Seedless Procrustes diff. norm using true pairs: </span><span class="si">{</span><span class="n">sp_diff_norm</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">op_diff_norm</span> <span class="o">=</span> <span class="n">calc_diff_norm</span><span class="p">(</span><span class="n">op_pred_left_out</span><span class="p">,</span> <span class="n">right_out</span><span class="p">[</span><span class="n">perm_inds</span><span class="p">,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">])</span>
<span class="n">sp_diff_norm</span> <span class="o">=</span> <span class="n">calc_diff_norm</span><span class="p">(</span><span class="n">sp_pred_left_out</span><span class="p">,</span> <span class="n">right_out</span><span class="p">[</span><span class="n">perm_inds</span><span class="p">,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Procrustes diff. norm using predicted pairs: </span><span class="si">{</span><span class="n">op_diff_norm</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Seedless Procrustes diff. norm using predicted pairs: </span><span class="si">{</span><span class="n">sp_diff_norm</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Procrustes diff. norm using true pairs: 3.754
Seedless Procrustes diff. norm using true pairs: 3.799
Procrustes diff. norm using predicted pairs: 3.761
Seedless Procrustes diff. norm using predicted pairs: 3.806
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plot-the-results-of-these-two-kinds-of-alignment-using-orthogonal-procrustes">
<h3>Plot the results of these two kinds of alignment using orthogonal Procrustes<a class="headerlink" href="#plot-the-results-of-these-two-kinds-of-alignment-using-orthogonal-procrustes" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_latents</span><span class="p">(</span>
    <span class="n">op_known_left_out</span><span class="p">,</span>
    <span class="n">right_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">],</span>
    <span class="s2">&quot;Out latent positions (known Procrustes alignment)&quot;</span><span class="p">,</span>
    <span class="n">n_show</span><span class="o">=</span><span class="n">n_components</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">stashfig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out-latent-op-known-preprocess=</span><span class="si">{</span><span class="n">preprocess</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">plot_latents</span><span class="p">(</span>
    <span class="n">op_pred_left_out</span><span class="p">,</span>
    <span class="n">right_out</span><span class="p">[</span><span class="n">perm_inds</span><span class="p">,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">],</span>
    <span class="s2">&quot;Out latent positions (predicted Procrustes alignment)&quot;</span><span class="p">,</span>
    <span class="n">n_show</span><span class="o">=</span><span class="n">n_components</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">stashfig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out-latent-op-pred-preprocess=</span><span class="si">{</span><span class="n">preprocess</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/align_investigation_17_0.png" src="_images/align_investigation_17_0.png" />
<img alt="_images/align_investigation_17_1.png" src="_images/align_investigation_17_1.png" />
</div>
</div>
</div>
<div class="section" id="plot-the-results-of-these-two-kinds-of-alignment-using-seedless-procrustes">
<h3>Plot the results of these two kinds of alignment using seedless Procrustes<a class="headerlink" href="#plot-the-results-of-these-two-kinds-of-alignment-using-seedless-procrustes" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_latents</span><span class="p">(</span>
    <span class="n">sp_known_left_out</span><span class="p">,</span>
    <span class="n">right_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">],</span>
    <span class="s2">&quot;Out latent positions (known SP alignment)&quot;</span><span class="p">,</span>
    <span class="n">n_show</span><span class="o">=</span><span class="n">n_components</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">stashfig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out-latent-sp-known-preprocess=</span><span class="si">{</span><span class="n">preprocess</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">plot_latents</span><span class="p">(</span>
    <span class="n">sp_pred_left_out</span><span class="p">,</span>
    <span class="n">right_out</span><span class="p">[</span><span class="n">perm_inds</span><span class="p">,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">],</span>
    <span class="s2">&quot;Out latent positions (predicted SP alignment)&quot;</span><span class="p">,</span>
    <span class="n">n_show</span><span class="o">=</span><span class="n">n_components</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">stashfig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out-latent-sp-pred-preprocess=</span><span class="si">{</span><span class="n">preprocess</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/align_investigation_19_0.png" src="_images/align_investigation_19_0.png" />
<img alt="_images/align_investigation_19_1.png" src="_images/align_investigation_19_1.png" />
</div>
</div>
</div>
<div class="section" id="plot-the-results-of-aligning-with-seedless-procrustes-using-all-dimension-flip-initializations">
<h3>Plot the results of aligning with seedless Procrustes using all dimension flip initializations<a class="headerlink" href="#plot-the-results-of-aligning-with-seedless-procrustes-using-all-dimension-flip-initializations" title="Permalink to this headline">¶</a></h3>
<p>Perhaps the results above settled into a local minima since we were initializing seedless
Procrustes from the orthogonal procustes solution. Here we restart from all of the
<span class="math notranslate nohighlight">\(2^d\)</span> possible dimension sign flips, and take the best solution over those.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sp</span> <span class="o">=</span> <span class="n">SeedlessProcrustes</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="s2">&quot;2d&quot;</span><span class="p">)</span>
<span class="n">sp_all_left_out</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
    <span class="n">left_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">],</span> <span class="n">right_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">plot_latents</span><span class="p">(</span>
    <span class="n">sp_all_left_out</span><span class="p">,</span>
    <span class="n">right_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">],</span>
    <span class="s2">&quot;Out latent positions (2^d restarts SP alignment)&quot;</span><span class="p">,</span>
    <span class="n">n_show</span><span class="o">=</span><span class="n">n_components</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">stashfig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out-latent-sp-2d-preprocess=</span><span class="si">{</span><span class="n">preprocess</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/align_investigation_21_0.png" src="_images/align_investigation_21_0.png" />
</div>
</div>
</div>
<div class="section" id="embed-using-omni-instead-of-ase-align">
<h3>Embed using Omni instead of ASE + align<a class="headerlink" href="#embed-using-omni-instead-of-ase-align" title="Permalink to this headline">¶</a></h3>
<p>Again, we use the try using either the known pairing or the best one that we have
predicted by graph matching.</p>
<p>Here we show the first 8 dimensions, because without doing any alignment post-embedding
we don’t need to worry about what happens in <span class="math notranslate nohighlight">\(d=3\)</span> vs <span class="math notranslate nohighlight">\(d=8\)</span> etc.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">omni</span> <span class="o">=</span> <span class="n">OmnibusEmbed</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">n_components</span><span class="p">)</span>
<span class="n">out_latents</span><span class="p">,</span> <span class="n">in_latents</span> <span class="o">=</span> <span class="n">omni</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">([</span><span class="n">ll_adj_to_embed</span><span class="p">,</span> <span class="n">rr_adj_to_embed</span><span class="p">])</span>
<span class="n">omni_left_out</span> <span class="o">=</span> <span class="n">out_latents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">omni_right_out</span> <span class="o">=</span> <span class="n">out_latents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">plot_latents</span><span class="p">(</span>
    <span class="n">omni_left_out</span><span class="p">,</span>
    <span class="n">omni_right_out</span><span class="p">,</span>
    <span class="s2">&quot;Out latent positions (known Omni)&quot;</span><span class="p">,</span>
    <span class="n">n_show</span><span class="o">=</span><span class="n">n_components</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">omni</span> <span class="o">=</span> <span class="n">OmnibusEmbed</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">n_components</span><span class="p">)</span>
<span class="n">out_latents</span><span class="p">,</span> <span class="n">in_latents</span> <span class="o">=</span> <span class="n">omni</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
    <span class="p">[</span><span class="n">ll_adj_to_embed</span><span class="p">,</span> <span class="n">rr_adj_to_embed</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">perm_inds</span><span class="p">,</span> <span class="n">perm_inds</span><span class="p">)]]</span>
<span class="p">)</span>
<span class="n">omni_pred_left_out</span> <span class="o">=</span> <span class="n">out_latents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">omni_pred_right_out</span> <span class="o">=</span> <span class="n">out_latents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">plot_latents</span><span class="p">(</span>
    <span class="n">omni_pred_left_out</span><span class="p">,</span>
    <span class="n">omni_pred_right_out</span><span class="p">,</span>
    <span class="s2">&quot;Out latent positions (predicted Omni)&quot;</span><span class="p">,</span>
    <span class="n">n_show</span><span class="o">=</span><span class="n">n_components</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.PairGrid at 0x7fc8fdfa3a30&gt;
</pre></div>
</div>
<img alt="_images/align_investigation_23_1.png" src="_images/align_investigation_23_1.png" />
<img alt="_images/align_investigation_23_2.png" src="_images/align_investigation_23_2.png" />
</div>
</div>
</div>
<div class="section" id="plot-the-left-omni-embedding-by-rough-cell-type">
<h3>Plot the left Omni embedding by rough cell type<a class="headerlink" href="#plot-the-left-omni-embedding-by-rough-cell-type" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">left_nodes</span> <span class="o">=</span> <span class="n">ll_mg</span><span class="o">.</span><span class="n">nodes</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">left_nodes</span> <span class="o">=</span> <span class="n">left_nodes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">sort_inds</span><span class="p">]</span>
<span class="n">left_nodes</span> <span class="o">=</span> <span class="n">left_nodes</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">lcc_inds</span><span class="p">]</span>
<span class="n">pairplot</span><span class="p">(</span>
    <span class="n">omni_left_out</span><span class="p">,</span>
    <span class="n">labels</span><span class="o">=</span><span class="n">left_nodes</span><span class="p">[</span><span class="s2">&quot;simple_group&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
    <span class="n">palette</span><span class="o">=</span><span class="n">load_palette</span><span class="p">(),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.PairGrid at 0x7fc8f08823d0&gt;
</pre></div>
</div>
<img alt="_images/align_investigation_25_1.png" src="_images/align_investigation_25_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="what-happens-when-we-remove-the-kenyon-cells">
<h2>What happens when we remove the Kenyon cells?<a class="headerlink" href="#what-happens-when-we-remove-the-kenyon-cells" title="Permalink to this headline">¶</a></h2>
<p>We can repeat much of the analysis from the above, but after removing the Kenyon
cells. These neurons are thought to be less bilaterally stereotyped than many other
neuron types. Note that most of the Kenyon cells were already not included in this
analysis since we started from only the paired neurons.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">no_kc_mg</span> <span class="o">=</span> <span class="n">mg</span><span class="p">[</span><span class="n">mg</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;simple_group&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;KCs&quot;</span><span class="p">]</span>

<span class="n">ll_mg</span><span class="p">,</span> <span class="n">rr_mg</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">no_kc_mg</span><span class="o">.</span><span class="n">bisect</span><span class="p">(</span><span class="n">paired</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">ll_adj</span> <span class="o">=</span> <span class="n">ll_mg</span><span class="o">.</span><span class="n">sum</span><span class="o">.</span><span class="n">adj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">rr_adj</span> <span class="o">=</span> <span class="n">rr_mg</span><span class="o">.</span><span class="n">sum</span><span class="o">.</span><span class="n">adj</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">nodes</span> <span class="o">=</span> <span class="n">ll_mg</span><span class="o">.</span><span class="n">nodes</span>
<span class="n">nodes</span><span class="p">[</span><span class="s2">&quot;_inds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes</span><span class="p">))</span>
<span class="n">sorted_nodes</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;simple_group&quot;</span><span class="p">])</span>
<span class="n">sort_inds</span> <span class="o">=</span> <span class="n">sorted_nodes</span><span class="p">[</span><span class="s2">&quot;_inds&quot;</span><span class="p">]</span>

<span class="n">ll_adj</span> <span class="o">=</span> <span class="n">ll_adj</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">sort_inds</span><span class="p">,</span> <span class="n">sort_inds</span><span class="p">)]</span>
<span class="n">rr_adj</span> <span class="o">=</span> <span class="n">rr_adj</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">sort_inds</span><span class="p">,</span> <span class="n">sort_inds</span><span class="p">)]</span>

<span class="n">adjs</span><span class="p">,</span> <span class="n">lcc_inds</span> <span class="o">=</span> <span class="n">multigraph_lcc_intersection</span><span class="p">([</span><span class="n">ll_adj</span><span class="p">,</span> <span class="n">rr_adj</span><span class="p">],</span> <span class="n">return_inds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ll_adj</span> <span class="o">=</span> <span class="n">adjs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">rr_adj</span> <span class="o">=</span> <span class="n">adjs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">lcc_inds</span><span class="p">)</span><span class="si">}</span><span class="s2"> in intersection of largest connected components.&quot;</span><span class="p">)</span>

<span class="n">plot_adjs</span><span class="p">(</span><span class="n">ll_adj</span><span class="p">,</span> <span class="n">rr_adj</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Known alignment, no KCs&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1129 in intersection of largest connected components.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;Figure size 1080x504 with 2 Axes&gt;,
 array([&lt;AxesSubplot:title={&#39;center&#39;:&#39;Left $\\to$ left&#39;}&gt;,
        &lt;AxesSubplot:title={&#39;center&#39;:&#39;Right $\\to$ right&#39;}&gt;], dtype=object))
</pre></div>
</div>
<img alt="_images/align_investigation_27_2.png" src="_images/align_investigation_27_2.png" />
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ll_adj_to_embed</span><span class="p">,</span> <span class="n">rr_adj_to_embed</span> <span class="o">=</span> <span class="n">preprocess_for_embed</span><span class="p">(</span><span class="n">ll_adj</span><span class="p">,</span> <span class="n">rr_adj</span><span class="p">,</span> <span class="n">preprocess</span><span class="p">)</span>

<span class="n">left_out</span><span class="p">,</span> <span class="n">left_in</span><span class="p">,</span> <span class="n">left_sing_vals</span><span class="p">,</span> <span class="n">left_elbow_inds</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span>
    <span class="n">ll_adj_to_embed</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="n">max_n_components</span>
<span class="p">)</span>
<span class="n">right_out</span><span class="p">,</span> <span class="n">right_in</span><span class="p">,</span> <span class="n">right_sing_vals</span><span class="p">,</span> <span class="n">right_elbow_inds</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span>
    <span class="n">rr_adj_to_embed</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="n">max_n_components</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="align-the-3-dimensional-out-embeddings-using-known-pairs">
<h3>Align the 3-dimensional out embeddings using known pairs<a class="headerlink" href="#align-the-3-dimensional-out-embeddings-using-known-pairs" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_components</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># this was a small dimension where we reject</span>
<span class="n">op_known_left_out</span><span class="p">,</span> <span class="n">sp_known_left_out</span> <span class="o">=</span> <span class="n">run_alignments</span><span class="p">(</span>
    <span class="n">left_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">],</span> <span class="n">right_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">]</span>
<span class="p">)</span>

<span class="n">op_diff_norm</span> <span class="o">=</span> <span class="n">calc_diff_norm</span><span class="p">(</span><span class="n">op_known_left_out</span><span class="p">,</span> <span class="n">right_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">])</span>
<span class="n">sp_diff_norm</span> <span class="o">=</span> <span class="n">calc_diff_norm</span><span class="p">(</span><span class="n">sp_known_left_out</span><span class="p">,</span> <span class="n">right_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Procrustes diff. norm using true pairs: </span><span class="si">{</span><span class="n">op_diff_norm</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Seedless Procrustes diff. norm using true pairs: </span><span class="si">{</span><span class="n">sp_diff_norm</span><span class="si">:</span><span class="s2">0.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Procrustes diff. norm using true pairs: 3.324
Seedless Procrustes diff. norm using true pairs: 3.326
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="plot-the-results-of-alignment-using-orthogonal-procrustes">
<h3>Plot the results of alignment using orthogonal Procrustes<a class="headerlink" href="#plot-the-results-of-alignment-using-orthogonal-procrustes" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_latents</span><span class="p">(</span>
    <span class="n">op_known_left_out</span><span class="p">,</span>
    <span class="n">right_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">],</span>
    <span class="s2">&quot;Out latent positions, no KC (known Procrustes alignment)&quot;</span><span class="p">,</span>
    <span class="n">n_show</span><span class="o">=</span><span class="n">n_components</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">stashfig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out-latent-no-kc-op-known-preprocess=</span><span class="si">{</span><span class="n">preprocess</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/align_investigation_32_0.png" src="_images/align_investigation_32_0.png" />
</div>
</div>
</div>
<div class="section" id="plot-the-results-of-alignment-using-seedless-procrustes">
<h3>Plot the results of alignment using seedless Procrustes<a class="headerlink" href="#plot-the-results-of-alignment-using-seedless-procrustes" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_latents</span><span class="p">(</span>
    <span class="n">sp_known_left_out</span><span class="p">,</span>
    <span class="n">right_out</span><span class="p">[:,</span> <span class="p">:</span><span class="n">n_components</span><span class="p">],</span>
    <span class="s2">&quot;Out latent positions, no KC (known SP alignment)&quot;</span><span class="p">,</span>
    <span class="n">n_show</span><span class="o">=</span><span class="n">n_components</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">stashfig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;out-latent-no-kc-sp-known-preprocess=</span><span class="si">{</span><span class="n">preprocess</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/align_investigation_34_0.png" src="_images/align_investigation_34_0.png" />
</div>
</div>
</div>
<div class="section" id="plot-the-embeddings-using-omni-with-the-known-pair-correspondence">
<h3>Plot the embeddings using Omni with the known pair correspondence<a class="headerlink" href="#plot-the-embeddings-using-omni-with-the-known-pair-correspondence" title="Permalink to this headline">¶</a></h3>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">omni</span> <span class="o">=</span> <span class="n">OmnibusEmbed</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">n_components</span><span class="p">)</span>
<span class="n">out_latents</span><span class="p">,</span> <span class="n">in_latents</span> <span class="o">=</span> <span class="n">omni</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">([</span><span class="n">ll_adj_to_embed</span><span class="p">,</span> <span class="n">rr_adj_to_embed</span><span class="p">])</span>
<span class="n">omni_left_out</span> <span class="o">=</span> <span class="n">out_latents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">omni_right_out</span> <span class="o">=</span> <span class="n">out_latents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">plot_latents</span><span class="p">(</span>
    <span class="n">omni_left_out</span><span class="p">,</span>
    <span class="n">omni_right_out</span><span class="p">,</span>
    <span class="s2">&quot;Out latent positions (known Omni)&quot;</span><span class="p">,</span>
    <span class="n">n_show</span><span class="o">=</span><span class="n">n_components</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.PairGrid at 0x7fc8fe28a370&gt;
</pre></div>
</div>
<img alt="_images/align_investigation_36_1.png" src="_images/align_investigation_36_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="end">
<h2>End<a class="headerlink" href="#end" title="Permalink to this headline">¶</a></h2>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
<span class="n">delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">elapsed</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Script took </span><span class="si">{</span><span class="n">delta</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed at </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>----
Script took 0:05:57.877405
Completed at 2021-03-22 09:33:34.012958
----
</pre></div>
</div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
        <div class='prev-next-bottom'>
            
    <a class='left-prev' id="prev-link" href="bilateral_symmetry.html" title="previous page">Testing bilateral symmetry</a>
    <a class='right-next' id="next-link" href="off_diagonal.html" title="next page">Off-diagonal and off-script</a>

        </div>
        
        </div>
    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By NeuroData<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="_static/js/index.d3f166471bb80abb5163.js"></script>


    
  </body>
</html>